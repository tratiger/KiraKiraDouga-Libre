name: Download Translations from Crowdin

on:
  workflow_dispatch:

jobs:
  Sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—ã—ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Crowdin CLI
      run: npm install -g @crowdin/cli

    - name: Delete remote translations branch (if exists)
      run: |
        git fetch origin
        if git ls-remote --exit-code --heads origin translations; then
          git push origin --delete translations
        fi

    - name: Create new translations branch
      run: |
        git checkout develop
        git pull origin develop
        git checkout -b translations
    - name: Download translations from Crowdin
      run: crowdin download translations --token ${{ secrets.CROWDIN_PERSONAL_TOKEN }} --project-id ${{ secrets.CROWDIN_PROJECT_ID }} -c crowdin.yml -b "[KIRAKIRA-DOUGA.KIRAKIRA-Rosales] develop"
      env:
        CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
        CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

    - name: Process translations
      run: |
        for file in src/locales/*.ts; do
          sed -i '/import type { LocaleIdentifiers } from ".\/types";/d' "$file"

          sed -i 's/} as const satisfies LocaleIdentifiers;/}/' "$file"
        done

    - name: Generate translated files list
      run: |
        # æœ€æ–°ã®ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’ç¢ºå®Ÿã«å–å¾—ã™ã‚‹
        git fetch origin develop:develop
        echo "GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸç¿»è¨³æ›´æ–°PRã€‚" > pr_body.txt
        echo "### ä»Šå›æ›´æ–°ã•ã‚ŒãŸç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«ï¼š" >> pr_body.txt
        git diff --diff-filter=M --name-only develop..translations -- src/locales | grep -E '\.ts$' >> pr_body.txt || echo "ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ãªã—" >> pr_body.txt
        echo "" >> pr_body.txt

    - name: Commit and push translations
      run: |
        mv src/locales/English.json src/locales/English.ts
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -m "ğŸŒ ç¿»è¨³ã‚’æ›´æ–°" || echo "No changes to commit"
        git add .
        git push --set-upstream origin translations --force

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: translations
        base: develop
        commit-message: 'ğŸŒ ç¿»è¨³ã‚’æ›´æ–°'
        title: "ğŸŒ ç¿»è¨³ã‚’æ›´æ–°"
        body-path: pr_body.txt
        labels: "translation, automated"
